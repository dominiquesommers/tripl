@if (map(); as map) {
  <app-map-search [map]="map"></app-map-search>
}

<div class="map-wrapper" style="position: relative; width: 100%; height: 100%;">
  <div #mapContainer id="map-container"
       class="map-container"
       [class.visible]="isMapVisible()">
  </div>


  <div class="map-interaction-overlay" [class.active]="tripService.drawingState().active">
    <div class="hint-toast">
      @if (tripService.drawingState().preselectedRoute) {
        Select a destination visit
      } @else {
        Select a destination visit or an existing route
      }
    </div>
  </div>
</div>

@if (tripService.selectedVisit(); as selectedVisit) {
  <app-visit-popup
    [visit]="selectedVisit"
    (onSave)="handlePlaceSave($event)"
    (onDelete)="handleVisitDelete($event)">
  </app-visit-popup>
}

@if (!tripService.selectedVisit() && tripService.selectedRoute(); as selectedRoute) {
  <app-route-popup
    [route]="selectedRoute"
    (onSave)="handleRouteSave($event)"
    (onDelete)="handleRouteDelete($any($event))">
  </app-route-popup>
}

@if (!tripService.selectedVisit() && !tripService.selectedRoute() && !tripService.hoveredRoute() && tripService.hoveredPlace()) {
  <app-place-tooltip [place]="tripService.hoveredPlace"></app-place-tooltip>
}

@if (!tripService.selectedVisit() && !tripService.selectedRoute() && !tripService.hoveredPlace() && tripService.hoveredRoute()) {
  <app-route-tooltip [route]="tripService.hoveredRoute"></app-route-tooltip>
}

<div style="position: absolute; left: -9999px;">
  @if (tripService.trip(); as trip) {
    @for (place of trip.placesArray(); track place.id) {
      <app-place-marker
        [place]="place"
        [hoveredPlace]="tripService.hoveredPlace"
        [selectedVisit]="tripService.selectedVisit"
        [zoom]="zoom">
      </app-place-marker>
    }
  }
</div>


@if (selectorVisible()) {
  <div class="route-type-selector"
       [style.left.px]="selectorPos().x"
       [style.top.px]="selectorPos().y">
    @for (type of availableTypes; track type) {
      <button class="icon-btn" (click)="$event.stopPropagation(); handleTypeSelection(type)">
        <lucide-icon [name]="getRouteIcon(type)" [size]="18"></lucide-icon>
      </button>
    }
  </div>
}
